name: Notify Slack on Merge to Stable
on:
  push:
    branches:
      - main
      - stable

jobs:
  slack-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        uses: actions/github-script@v6
        id: pr
        with:
          result-encoding: string
          script: |
            const pr = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
            });
            return pr.data[0]?.title || "Sin tÃ­tulo de PR";

      - name: Send to Slack via slackapi/slack-github-action
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "channel": "#in-store-releases",
              "text": "ðŸ“¦ *Nuevo merge a `${{ github.ref_name }}`*\nðŸ”¹ *PR:* ${{ steps.pr.outputs.result }}\nðŸ”¸ *Autor:* <@${{ github.actor }}>\nðŸ”¹ *Commit:* <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|Ver en GitHub>\n\nðŸ‘‰ Completa el hilo con:\n1. Â¿Pruebas en staging?\n2. Â¿ValidaciÃ³n en laboratorio?\n3. Â¿Deuda tÃ©cnica?"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
